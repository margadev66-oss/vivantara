version: 1
frontend:
  phases:
    preBuild:
      commands:
        - npm ci
    build:
      commands:
        - rm -f .env.production
        - touch .env.production
        - |
          if [ -z "${NEXTAUTH_SECRET:-}" ] && [ -z "${AUTH_SECRET:-}" ]; then
            echo "Missing NEXTAUTH_SECRET or AUTH_SECRET in Amplify environment variables."
            exit 1
          fi
        - |
          if [ -n "${DATABASE_URL:-}" ]; then
            printf '%s=%s\n' "DATABASE_URL" "$DATABASE_URL" >> .env.production
          fi
          if [ -n "${NEXTAUTH_SECRET:-}" ]; then
            printf '%s=%s\n' "NEXTAUTH_SECRET" "$NEXTAUTH_SECRET" >> .env.production
          fi
          if [ -n "${AUTH_SECRET:-}" ]; then
            printf '%s=%s\n' "AUTH_SECRET" "$AUTH_SECRET" >> .env.production
          fi
          if [ -n "${NEXTAUTH_URL:-}" ]; then
            printf '%s=%s\n' "NEXTAUTH_URL" "$NEXTAUTH_URL" >> .env.production
          fi
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
